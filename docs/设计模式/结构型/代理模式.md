# ã€Šå‰ç«¯è®¾è®¡æ¨¡å¼å®æˆ˜æ‰‹å†Œã€‹

## ç¬¬åäºŒç« ï¼šä»£ç†æ¨¡å¼ï¼ˆProxy Patternï¼‰

---

### ğŸ¯ ä¸€å¥è¯å¤§ç™½è¯

> **ä»£ç†æ¨¡å¼å°±åƒæ˜æ˜Ÿçš„ç»çºªäººï¼šä½ æƒ³æ‰¾æ˜æ˜Ÿæ‹å¹¿å‘Šï¼Œä¸èƒ½ç›´æ¥è”ç³»æ˜æ˜Ÿï¼Œå¿…é¡»å…ˆé€šè¿‡ç»çºªäººã€‚ç»çºªäººä¼šå¸®ä½ ç­›é€‰è¯·æ±‚ã€è°ˆä»·æ ¼ã€å®‰æ’æ¡£æœŸï¼Œæœ€åæ‰è®©æ˜æ˜Ÿå‡ºé¢ã€‚ä»£ç†æ¨¡å¼å°±æ˜¯ç»™å¯¹è±¡åŠ ä¸€ä¸ª"ç»çºªäºº"ï¼Œæ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—®ã€‚**

**æ ¸å¿ƒç†å¿µï¼šä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚**

---

### ğŸ¤” ä»€ä¹ˆæ—¶å€™éœ€è¦"ä»£ç†"ï¼Ÿ

åœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°éœ€è¦æ§åˆ¶å¯¹è±¡è®¿é—®çš„åœºæ™¯ï¼š

| åœºæ™¯ | ä¸ºä»€ä¹ˆéœ€è¦ä»£ç†æ¨¡å¼ |
|------|------------------|
| **å›¾ç‰‡æ‡’åŠ è½½** | æ§åˆ¶å›¾ç‰‡åŠ è½½æ—¶æœºï¼Œæé«˜æ€§èƒ½ |
| **API è¯·æ±‚ç¼“å­˜** | ç¼“å­˜è¯·æ±‚ç»“æœï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚ |
| **æƒé™æ§åˆ¶** | æ§åˆ¶å¯¹æ•æ„Ÿæ“ä½œçš„è®¿é—® |
| **é˜²æŠ–èŠ‚æµ** | æ§åˆ¶å‡½æ•°è°ƒç”¨é¢‘ç‡ |
| **æ•°æ®éªŒè¯** | åœ¨è®¿é—®å‰éªŒè¯æ•°æ® |
| **æ—¥å¿—è®°å½•** | è®°å½•å¯¹è±¡è®¿é—®æ—¥å¿— |
| **æ€§èƒ½ç›‘æ§** | ç›‘æ§å¯¹è±¡è®¿é—®æ€§èƒ½ |

---

### ğŸ˜« å‰ç«¯ç—›ç‚¹ï¼šæ²¡æœ‰ä»£ç†æ—¶çš„å™©æ¢¦

#### åœºæ™¯ä¸€ï¼šå›¾ç‰‡åŠ è½½æ€§èƒ½é—®é¢˜

```tsx
// âŒ å™©æ¢¦ä»£ç ï¼šæ‰€æœ‰å›¾ç‰‡ä¸€æ¬¡æ€§åŠ è½½ï¼Œé¡µé¢å¡é¡¿

const ImageList: React.FC = () => {
  const images = Array.from({ length: 100 }, (_, i) => ({
    id: i,
    url: `https://example.com/image${i}.jpg`,
  }));
  
  return (
    <div>
      {images.map(image => (
        <img
          key={image.id}
          src={image.url}  // æ‰€æœ‰å›¾ç‰‡ç«‹å³åŠ è½½ï¼Œé¡µé¢å¡é¡¿
          alt={`Image ${image.id}`}
        />
      ))}
    </div>
  );
};

// é—®é¢˜ï¼š
// 1. 100 å¼ å›¾ç‰‡åŒæ—¶åŠ è½½ï¼Œç½‘ç»œå‹åŠ›å¤§
// 2. é¡µé¢æ¸²æŸ“å¡é¡¿
// 3. ç”¨æˆ·å¯èƒ½åªçœ‹å‰å‡ å¼ ï¼Œåé¢çš„å›¾ç‰‡æµªè´¹æµé‡
```

#### åœºæ™¯äºŒï¼šAPI è¯·æ±‚é‡å¤

```tsx
// âŒ å™©æ¢¦ä»£ç ï¼šç›¸åŒè¯·æ±‚é‡å¤å‘é€

const UserProfile: React.FC<{ userId: string }> = ({ userId }) => {
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    // æ¯æ¬¡ç»„ä»¶æŒ‚è½½éƒ½è¯·æ±‚ï¼Œå³ä½¿æ•°æ®æ²¡å˜
    fetch(`/api/users/${userId}`)
      .then(res => res.json())
      .then(setUser);
  }, [userId]);
  
  return <div>{user?.name}</div>;
};

// å¤šä¸ªç»„ä»¶åŒæ—¶ä½¿ç”¨
const App: React.FC = () => {
  return (
    <div>
      <UserProfile userId="123" />  {/* è¯·æ±‚ 1 */}
      <UserProfile userId="123" />  {/* è¯·æ±‚ 2 - é‡å¤ï¼ */}
      <UserProfile userId="123" />  {/* è¯·æ±‚ 3 - é‡å¤ï¼ */}
    </div>
  );
};

// é—®é¢˜ï¼š
// 1. ç›¸åŒè¯·æ±‚é‡å¤å‘é€
// 2. æµªè´¹ç½‘ç»œèµ„æº
// 3. æœåŠ¡å™¨å‹åŠ›å¤§
```

#### åœºæ™¯ä¸‰ï¼šæƒé™æ§åˆ¶åˆ†æ•£

```tsx
// âŒ å™©æ¢¦ä»£ç ï¼šæƒé™æ£€æŸ¥ä»£ç æ•£è½å„å¤„

const deleteUser = async (id: string) => {
  // æƒé™æ£€æŸ¥
  const user = getCurrentUser();
  if (!user.permissions.includes('user:delete')) {
    throw new Error('æ²¡æœ‰æƒé™');
  }
  
  // ä¸šåŠ¡é€»è¾‘
  await fetch(`/api/users/${id}`, { method: 'DELETE' });
};

const updateUser = async (id: string, data: any) => {
  // åˆæ˜¯æƒé™æ£€æŸ¥
  const user = getCurrentUser();
  if (!user.permissions.includes('user:update')) {
    throw new Error('æ²¡æœ‰æƒé™');
  }
  
  // ä¸šåŠ¡é€»è¾‘
  await fetch(`/api/users/${id}`, { method: 'PUT', body: JSON.stringify(data) });
};

// é—®é¢˜ï¼š
// 1. æƒé™æ£€æŸ¥ä»£ç é‡å¤
// 2. å®¹æ˜“é—æ¼æƒé™æ£€æŸ¥
// 3. æƒé™é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘è€¦åˆ
```

**è¿™äº›ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ**

| é—®é¢˜ | æè¿° |
|------|------|
| ğŸ”´ **æ€§èƒ½é—®é¢˜** | å›¾ç‰‡ä¸€æ¬¡æ€§åŠ è½½ã€è¯·æ±‚é‡å¤å‘é€ |
| ğŸ”´ **ä»£ç é‡å¤** | æƒé™æ£€æŸ¥ã€æ—¥å¿—è®°å½•ç­‰ä»£ç é‡å¤ |
| ğŸ”´ **èŒè´£æ··ä¹±** | ä¸šåŠ¡é€»è¾‘å’Œæ¨ªåˆ‡å…³æ³¨ç‚¹æ··åœ¨ä¸€èµ· |
| ğŸ”´ **éš¾ä»¥ç»´æŠ¤** | è¦æ”¹æƒé™é€»è¾‘ï¼Ÿæ”¹ N ä¸ªåœ°æ–¹ |

---

### ğŸ’¡ æ¨¡å¼æ ¸å¿ƒæ¦‚å¿µ

ä»£ç†æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

> **ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚**

ç”¨å¤§ç™½è¯è¯´å°±æ˜¯ï¼š
- **ä¸»é¢˜ï¼ˆSubjectï¼‰**ï¼šå®šä¹‰çœŸå®å¯¹è±¡å’Œä»£ç†çš„å…±åŒæ¥å£
- **çœŸå®å¯¹è±¡ï¼ˆReal Subjectï¼‰**ï¼šè¢«ä»£ç†çš„å¯¹è±¡ï¼Œæ‰§è¡Œå®é™…ä¸šåŠ¡
- **ä»£ç†ï¼ˆProxyï¼‰**ï¼šæ§åˆ¶å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®ï¼Œå¯ä»¥æ·»åŠ é¢å¤–åŠŸèƒ½

**ä»£ç†æ¨¡å¼çš„ç»“æ„ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Subject   â”‚  â† å…±åŒæ¥å£
â”‚  (ä¸»é¢˜æ¥å£)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + request() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Proxy  â”‚ â”‚   Real   â”‚
â”‚ (ä»£ç†)   â”‚ â”‚ Subject â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚(çœŸå®å¯¹è±¡) â”‚
â”‚+request â”‚ â”‚          â”‚
â”‚ -real   â”‚ â”‚+request  â”‚
â”‚ Subject â”‚ â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç†æ¨¡å¼çš„ç±»å‹ï¼š**

| ç±»å‹ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| **è™šæ‹Ÿä»£ç†** | å»¶è¿Ÿåˆ›å»º/åŠ è½½ | å›¾ç‰‡æ‡’åŠ è½½ã€ç»„ä»¶æ‡’åŠ è½½ |
| **ç¼“å­˜ä»£ç†** | ç¼“å­˜ç»“æœ | API è¯·æ±‚ç¼“å­˜ |
| **ä¿æŠ¤ä»£ç†** | è®¿é—®æ§åˆ¶ | æƒé™æ§åˆ¶ã€æ•°æ®éªŒè¯ |
| **è¿œç¨‹ä»£ç†** | è¿œç¨‹è®¿é—® | RPC è°ƒç”¨ |
| **æ™ºèƒ½ä»£ç†** | é¢å¤–åŠŸèƒ½ | æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§ |

**ç±»æ¯”ç†è§£ï¼š**

```
æ²¡æœ‰ä»£ç†ï¼šç›´æ¥æ‰¾æ˜æ˜Ÿ â†’ å¯èƒ½è¢«æ‹’ç»ã€ä»·æ ¼ä¸é€æ˜
æœ‰ä»£ç†ï¼šé€šè¿‡ç»çºªäºº â†’ ç»Ÿä¸€å¤„ç†ã€æ§åˆ¶è®¿é—®ã€æ·»åŠ æœåŠ¡
```

---

### ğŸ”§ å‰ç«¯å®æˆ˜æ¡ˆä¾‹ä¸€ï¼šå›¾ç‰‡æ‡’åŠ è½½ä»£ç†

#### åœºæ™¯æè¿°

ä½¿ç”¨ä»£ç†æ¨¡å¼å®ç°å›¾ç‰‡æ‡’åŠ è½½ï¼Œæ§åˆ¶å›¾ç‰‡åŠ è½½æ—¶æœºï¼Œæé«˜æ€§èƒ½ã€‚

```tsx
// proxy/ImageProxy.tsx

import React, { useState, useEffect, useRef } from 'react';

/**
 * å›¾ç‰‡ä»£ç†ç»„ä»¶
 * 
 * è™šæ‹Ÿä»£ç†ï¼šå»¶è¿ŸåŠ è½½å›¾ç‰‡ï¼Œåªæœ‰å½“å›¾ç‰‡è¿›å…¥è§†å£æ—¶æ‰åŠ è½½
 */
export const LazyImage: React.FC<{
  src: string;
  alt: string;
  placeholder?: string;
  className?: string;
  style?: React.CSSProperties;
}> = ({ src, alt, placeholder, className, style }) => {
  const [imageSrc, setImageSrc] = useState<string>(placeholder || '');
  const [isLoaded, setIsLoaded] = useState(false);
  const [isInView, setIsInView] = useState(false);
  const imgRef = useRef<HTMLImageElement>(null);
  
  useEffect(() => {
    // ä½¿ç”¨ Intersection Observer æ£€æµ‹å›¾ç‰‡æ˜¯å¦è¿›å…¥è§†å£
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            setIsInView(true);
            observer.disconnect();
          }
        });
      },
      {
        rootMargin: '50px', // æå‰ 50px å¼€å§‹åŠ è½½
      }
    );
    
    if (imgRef.current) {
      observer.observe(imgRef.current);
    }
    
    return () => {
      observer.disconnect();
    };
  }, []);
  
  useEffect(() => {
    // åªæœ‰å½“å›¾ç‰‡è¿›å…¥è§†å£æ—¶æ‰å¼€å§‹åŠ è½½
    if (isInView && !isLoaded) {
      const img = new Image();
      
      img.onload = () => {
        setImageSrc(src);
        setIsLoaded(true);
      };
      
      img.onerror = () => {
        // åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºå ä½å›¾
        setImageSrc(placeholder || '');
      };
      
      img.src = src;
    }
  }, [isInView, src, placeholder, isLoaded]);
  
  return (
    <img
      ref={imgRef}
      src={imageSrc}
      alt={alt}
      className={className}
      style={{
        ...style,
        transition: 'opacity 0.3s',
        opacity: isLoaded ? 1 : 0.5,
      }}
    />
  );
};
```

#### ä¸šåŠ¡ä¸­ä½¿ç”¨

```tsx
// components/ImageGallery.tsx

import React from 'react';
import { LazyImage } from '../proxy/ImageProxy';

export const ImageGallery: React.FC = () => {
  const images = Array.from({ length: 100 }, (_, i) => ({
    id: i,
    url: `https://example.com/image${i}.jpg`,
    alt: `Image ${i}`,
  }));
  
  return (
    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16 }}>
      {images.map(image => (
        <LazyImage
          key={image.id}
          src={image.url}
          alt={image.alt}
          placeholder="https://via.placeholder.com/300"
          style={{ width: '100%', height: 'auto' }}
        />
      ))}
    </div>
  );
};

// æ€§èƒ½å¯¹æ¯”ï¼š
// ä¸ä½¿ç”¨ä»£ç†ï¼š100 å¼ å›¾ç‰‡ç«‹å³åŠ è½½ï¼Œé¡µé¢å¡é¡¿
// ä½¿ç”¨ä»£ç†ï¼šåªåŠ è½½å¯è§åŒºåŸŸçš„å›¾ç‰‡ï¼Œæ€§èƒ½æå‡æ˜æ˜¾
```

---

### ğŸ”§ å‰ç«¯å®æˆ˜æ¡ˆä¾‹äºŒï¼šAPI è¯·æ±‚ç¼“å­˜ä»£ç†

#### åœºæ™¯æè¿°

ä½¿ç”¨ä»£ç†æ¨¡å¼å®ç° API è¯·æ±‚ç¼“å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚ã€‚

```tsx
// proxy/ApiCacheProxy.ts

/**
 * API è¯·æ±‚æ¥å£
 */
interface ApiService {
  get<T>(url: string): Promise<T>;
  post<T>(url: string, data?: any): Promise<T>;
}

/**
 * çœŸå® API æœåŠ¡
 */
class RealApiService implements ApiService {
  async get<T>(url: string): Promise<T> {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  }
  
  async post<T>(url: string, data?: any): Promise<T> {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: data ? JSON.stringify(data) : undefined,
    });
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  }
}

/**
 * API ç¼“å­˜ä»£ç†
 * 
 * ç¼“å­˜ä»£ç†ï¼šç¼“å­˜ GET è¯·æ±‚ç»“æœï¼Œé¿å…é‡å¤è¯·æ±‚
 */
export class ApiCacheProxy implements ApiService {
  private realService: ApiService;
  private cache: Map<string, { data: any; expireAt: number }> = new Map();
  private defaultTTL: number = 5 * 60 * 1000; // é»˜è®¤ 5 åˆ†é’Ÿ
  
  constructor(ttl?: number) {
    this.realService = new RealApiService();
    if (ttl) {
      this.defaultTTL = ttl;
    }
  }
  
  /**
   * GET è¯·æ±‚ï¼ˆå¸¦ç¼“å­˜ï¼‰
   */
  async get<T>(url: string, ttl?: number): Promise<T> {
    const cacheKey = `GET:${url}`;
    const cached = this.cache.get(cacheKey);
    
    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
    if (cached && Date.now() < cached.expireAt) {
      console.log(`[CACHE] å‘½ä¸­ç¼“å­˜: ${url}`);
      return cached.data as T;
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨çœŸå®æœåŠ¡
    console.log(`[CACHE] ç¼“å­˜æœªå‘½ä¸­ï¼Œè¯·æ±‚: ${url}`);
    const data = await this.realService.get<T>(url);
    
    // å­˜å…¥ç¼“å­˜
    this.cache.set(cacheKey, {
      data,
      expireAt: Date.now() + (ttl || this.defaultTTL),
    });
    
    return data;
  }
  
  /**
   * POST è¯·æ±‚ï¼ˆä¸ç¼“å­˜ï¼‰
   */
  async post<T>(url: string, data?: any): Promise<T> {
    // POST è¯·æ±‚é€šå¸¸ä¸ç¼“å­˜ï¼Œç›´æ¥è°ƒç”¨çœŸå®æœåŠ¡
    return this.realService.post<T>(url, data);
  }
  
  /**
   * æ¸…é™¤ç¼“å­˜
   */
  clearCache(url?: string): void {
    if (url) {
      this.cache.delete(`GET:${url}`);
    } else {
      this.cache.clear();
    }
  }
  
  /**
   * è·å–ç¼“å­˜ç»Ÿè®¡
   */
  getCacheStats(): { size: number; keys: string[] } {
    return {
      size: this.cache.size,
      keys: Array.from(this.cache.keys()),
    };
  }
}

// åˆ›å»ºå•ä¾‹
export const apiCacheProxy = new ApiCacheProxy();
```

#### ä¸šåŠ¡ä¸­ä½¿ç”¨

```tsx
// services/userService.ts

import { apiCacheProxy } from '../proxy/ApiCacheProxy';

interface User {
  id: string;
  name: string;
  email: string;
}

export const userService = {
  /**
   * è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆå¸¦ç¼“å­˜ï¼‰
   */
  async getUsers(): Promise<User[]> {
    return apiCacheProxy.get<User[]>('/api/users');
  },
  
  /**
   * è·å–ç”¨æˆ·è¯¦æƒ…ï¼ˆå¸¦ç¼“å­˜ï¼‰
   */
  async getUserById(id: string): Promise<User> {
    return apiCacheProxy.get<User>(`/api/users/${id}`);
  },
  
  /**
   * åˆ›å»ºç”¨æˆ·ï¼ˆä¸ç¼“å­˜ï¼‰
   */
  async createUser(userData: Omit<User, 'id'>): Promise<User> {
    const result = await apiCacheProxy.post<User>('/api/users', userData);
    // åˆ›å»ºåæ¸…é™¤åˆ—è¡¨ç¼“å­˜
    apiCacheProxy.clearCache('/api/users');
    return result;
  },
};

// ç»„ä»¶ä¸­ä½¿ç”¨
const UserProfile: React.FC<{ userId: string }> = ({ userId }) => {
  const [user, setUser] = useState<User | null>(null);
  
  useEffect(() => {
    // âœ… å¤šæ¬¡è°ƒç”¨åªä¼šè¯·æ±‚ä¸€æ¬¡ï¼Œåç»­ä»ç¼“å­˜è¯»å–
    userService.getUserById(userId).then(setUser);
  }, [userId]);
  
  return <div>{user?.name}</div>;
};

// å¤šä¸ªç»„ä»¶åŒæ—¶ä½¿ç”¨
const App: React.FC = () => {
  return (
    <div>
      <UserProfile userId="123" />  {/* è¯·æ±‚ */}
      <UserProfile userId="123" />  {/* ä»ç¼“å­˜è¯»å– */}
      <UserProfile userId="123" />  {/* ä»ç¼“å­˜è¯»å– */}
    </div>
  );
};
```

---

### ğŸ”§ å‰ç«¯å®æˆ˜æ¡ˆä¾‹ä¸‰ï¼šæƒé™æ§åˆ¶ä»£ç†

#### åœºæ™¯æè¿°

ä½¿ç”¨ä»£ç†æ¨¡å¼å®ç°æƒé™æ§åˆ¶ï¼Œç»Ÿä¸€ç®¡ç†æƒé™æ£€æŸ¥é€»è¾‘ã€‚

```tsx
// proxy/PermissionProxy.ts

/**
 * ç”¨æˆ·æœåŠ¡æ¥å£
 */
interface UserService {
  deleteUser(id: string): Promise<void>;
  updateUser(id: string, data: any): Promise<void>;
  createUser(data: any): Promise<void>;
}

/**
 * çœŸå®ç”¨æˆ·æœåŠ¡
 */
class RealUserService implements UserService {
  async deleteUser(id: string): Promise<void> {
    await fetch(`/api/users/${id}`, { method: 'DELETE' });
  }
  
  async updateUser(id: string, data: any): Promise<void> {
    await fetch(`/api/users/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
  }
  
  async createUser(data: any): Promise<void> {
    await fetch('/api/users', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
  }
}

/**
 * æƒé™æ§åˆ¶ä»£ç†
 * 
 * ä¿æŠ¤ä»£ç†ï¼šåœ¨è°ƒç”¨çœŸå®æœåŠ¡å‰æ£€æŸ¥æƒé™
 */
export class PermissionProxy implements UserService {
  private realService: UserService;
  private getUserPermissions: () => string[];
  
  constructor(getUserPermissions: () => string[]) {
    this.realService = new RealUserService();
    this.getUserPermissions = getUserPermissions;
  }
  
  /**
   * æ£€æŸ¥æƒé™
   */
  private checkPermission(permission: string): void {
    const permissions = this.getUserPermissions();
    if (!permissions.includes(permission)) {
      throw new Error(`æ²¡æœ‰æƒé™: ${permission}`);
    }
  }
  
  /**
   * åˆ é™¤ç”¨æˆ·ï¼ˆéœ€è¦æƒé™ï¼‰
   */
  async deleteUser(id: string): Promise<void> {
    this.checkPermission('user:delete');
    return this.realService.deleteUser(id);
  }
  
  /**
   * æ›´æ–°ç”¨æˆ·ï¼ˆéœ€è¦æƒé™ï¼‰
   */
  async updateUser(id: string, data: any): Promise<void> {
    this.checkPermission('user:update');
    return this.realService.updateUser(id, data);
  }
  
  /**
   * åˆ›å»ºç”¨æˆ·ï¼ˆéœ€è¦æƒé™ï¼‰
   */
  async createUser(data: any): Promise<void> {
    this.checkPermission('user:create');
    return this.realService.createUser(data);
  }
}

// åˆ›å»ºä»£ç†å®ä¾‹
export const createUserServiceWithPermission = (getUserPermissions: () => string[]) => {
  return new PermissionProxy(getUserPermissions);
};
```

#### ä¸šåŠ¡ä¸­ä½¿ç”¨

```tsx
// services/userService.ts

import { createUserServiceWithPermission } from '../proxy/PermissionProxy';

// âœ… ä½¿ç”¨æƒé™ä»£ç†ï¼Œç»Ÿä¸€ç®¡ç†æƒé™æ£€æŸ¥
export const userService = createUserServiceWithPermission(() => {
  // ä»ä¸Šä¸‹æ–‡æˆ– store è·å–ç”¨æˆ·æƒé™
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  return user.permissions || [];
});

// ç»„ä»¶ä¸­ä½¿ç”¨
const UserList: React.FC = () => {
  const handleDelete = async (id: string) => {
    try {
      // âœ… è‡ªåŠ¨æ£€æŸ¥æƒé™ï¼Œä¸éœ€è¦æ‰‹åŠ¨å†™æƒé™æ£€æŸ¥ä»£ç 
      await userService.deleteUser(id);
      message.success('åˆ é™¤æˆåŠŸ');
    } catch (error) {
      message.error(error.message); // "æ²¡æœ‰æƒé™: user:delete"
    }
  };
  
  return (
    <div>
      <Button onClick={() => handleDelete('123')}>åˆ é™¤ç”¨æˆ·</Button>
    </div>
  );
};
```

---

### ğŸ”§ å‰ç«¯å®æˆ˜æ¡ˆä¾‹å››ï¼šé˜²æŠ–èŠ‚æµä»£ç†

#### åœºæ™¯æè¿°

ä½¿ç”¨ä»£ç†æ¨¡å¼å®ç°é˜²æŠ–å’ŒèŠ‚æµï¼Œæ§åˆ¶å‡½æ•°è°ƒç”¨é¢‘ç‡ã€‚

```tsx
// proxy/ThrottleProxy.ts

/**
 * å‡½æ•°æ¥å£
 */
type FunctionType = (...args: any[]) => any;

/**
 * é˜²æŠ–ä»£ç†
 * 
 * ä¿æŠ¤ä»£ç†ï¼šæ§åˆ¶å‡½æ•°è°ƒç”¨é¢‘ç‡ï¼Œå»¶è¿Ÿæ‰§è¡Œ
 */
export function debounceProxy<T extends FunctionType>(
  func: T,
  delay: number = 300
): T {
  let timeoutId: NodeJS.Timeout | null = null;
  
  return ((...args: any[]) => {
    if (timeoutId) {
      clearTimeout(timeoutId);
    }
    
    timeoutId = setTimeout(() => {
      func(...args);
    }, delay);
  }) as T;
}

/**
 * èŠ‚æµä»£ç†
 * 
 * ä¿æŠ¤ä»£ç†ï¼šæ§åˆ¶å‡½æ•°è°ƒç”¨é¢‘ç‡ï¼Œé™åˆ¶æ‰§è¡Œæ¬¡æ•°
 */
export function throttleProxy<T extends FunctionType>(
  func: T,
  delay: number = 300
): T {
  let lastCallTime = 0;
  
  return ((...args: any[]) => {
    const now = Date.now();
    
    if (now - lastCallTime >= delay) {
      lastCallTime = now;
      func(...args);
    }
  }) as T;
}

/**
 * é˜²æŠ–èŠ‚æµä»£ç†ï¼ˆç±»å½¢å¼ï¼‰
 */
export class ThrottleProxy {
  /**
   * åˆ›å»ºé˜²æŠ–å‡½æ•°
   */
  static debounce<T extends FunctionType>(func: T, delay: number = 300): T {
    return debounceProxy(func, delay);
  }
  
  /**
   * åˆ›å»ºèŠ‚æµå‡½æ•°
   */
  static throttle<T extends FunctionType>(func: T, delay: number = 300): T {
    return throttleProxy(func, delay);
  }
}
```

#### ä¸šåŠ¡ä¸­ä½¿ç”¨

```tsx
// components/SearchInput.tsx

import React, { useState } from 'react';
import { Input } from 'antd';
import { ThrottleProxy } from '../proxy/ThrottleProxy';

export const SearchInput: React.FC = () => {
  const [keyword, setKeyword] = useState('');
  
  // æœç´¢å‡½æ•°
  const handleSearch = (value: string) => {
    console.log('æœç´¢:', value);
    // æ‰§è¡Œæœç´¢é€»è¾‘
    fetch(`/api/search?q=${value}`)
      .then(res => res.json())
      .then(data => {
        console.log('æœç´¢ç»“æœ:', data);
      });
  };
  
  // âœ… ä½¿ç”¨èŠ‚æµä»£ç†ï¼Œé™åˆ¶æœç´¢é¢‘ç‡
  const throttledSearch = ThrottleProxy.throttle(handleSearch, 500);
  
  return (
    <Input
      value={keyword}
      onChange={(e) => {
        const value = e.target.value;
        setKeyword(value);
        // è‡ªåŠ¨èŠ‚æµï¼Œä¸ä¼šé¢‘ç¹è°ƒç”¨
        throttledSearch(value);
      }}
      placeholder="æœç´¢..."
    />
  );
};

// é˜²æŠ–ç¤ºä¾‹ï¼šè¡¨å•æäº¤
const FormSubmit: React.FC = () => {
  const handleSubmit = () => {
    console.log('æäº¤è¡¨å•');
  };
  
  // âœ… ä½¿ç”¨é˜²æŠ–ä»£ç†ï¼Œé˜²æ­¢é‡å¤æäº¤
  const debouncedSubmit = ThrottleProxy.debounce(handleSubmit, 1000);
  
  return (
    <Button onClick={debouncedSubmit}>
      æäº¤
    </Button>
  );
};
```

---

### ğŸ”§ å‰ç«¯å®æˆ˜æ¡ˆä¾‹äº”ï¼šæ•°æ®éªŒè¯ä»£ç†

#### åœºæ™¯æè¿°

ä½¿ç”¨ä»£ç†æ¨¡å¼å®ç°æ•°æ®éªŒè¯ï¼Œåœ¨è®¿é—®æ•°æ®å‰è¿›è¡ŒéªŒè¯ã€‚

```tsx
// proxy/ValidationProxy.ts

/**
 * æ•°æ®æœåŠ¡æ¥å£
 */
interface DataService {
  setData(key: string, value: any): void;
  getData(key: string): any;
}

/**
 * çœŸå®æ•°æ®æœåŠ¡
 */
class RealDataService implements DataService {
  private data: Map<string, any> = new Map();
  
  setData(key: string, value: any): void {
    this.data.set(key, value);
  }
  
  getData(key: string): any {
    return this.data.get(key);
  }
}

/**
 * æ•°æ®éªŒè¯è§„åˆ™
 */
interface ValidationRule {
  required?: boolean;
  type?: 'string' | 'number' | 'boolean' | 'object' | 'array';
  min?: number;
  max?: number;
  pattern?: RegExp;
  validator?: (value: any) => boolean;
}

/**
 * æ•°æ®éªŒè¯ä»£ç†
 * 
 * ä¿æŠ¤ä»£ç†ï¼šåœ¨è®¾ç½®æ•°æ®å‰è¿›è¡ŒéªŒè¯
 */
export class ValidationProxy implements DataService {
  private realService: DataService;
  private rules: Map<string, ValidationRule[]> = new Map();
  
  constructor() {
    this.realService = new RealDataService();
  }
  
  /**
   * æ³¨å†ŒéªŒè¯è§„åˆ™
   */
  registerRule(key: string, rule: ValidationRule): void {
    if (!this.rules.has(key)) {
      this.rules.set(key, []);
    }
    this.rules.get(key)!.push(rule);
  }
  
  /**
   * éªŒè¯æ•°æ®
   */
  private validate(key: string, value: any): void {
    const rules = this.rules.get(key) || [];
    
    for (const rule of rules) {
      // å¿…å¡«éªŒè¯
      if (rule.required && (value === undefined || value === null || value === '')) {
        throw new Error(`${key} æ˜¯å¿…å¡«é¡¹`);
      }
      
      // ç±»å‹éªŒè¯
      if (rule.type) {
        const actualType = Array.isArray(value) ? 'array' : typeof value;
        if (actualType !== rule.type) {
          throw new Error(`${key} ç±»å‹é”™è¯¯ï¼ŒæœŸæœ› ${rule.type}ï¼Œå®é™… ${actualType}`);
        }
      }
      
      // é•¿åº¦éªŒè¯
      if (rule.min !== undefined && value.length < rule.min) {
        throw new Error(`${key} é•¿åº¦ä¸èƒ½å°äº ${rule.min}`);
      }
      
      if (rule.max !== undefined && value.length > rule.max) {
        throw new Error(`${key} é•¿åº¦ä¸èƒ½å¤§äº ${rule.max}`);
      }
      
      // æ­£åˆ™éªŒè¯
      if (rule.pattern && !rule.pattern.test(value)) {
        throw new Error(`${key} æ ¼å¼ä¸æ­£ç¡®`);
      }
      
      // è‡ªå®šä¹‰éªŒè¯
      if (rule.validator && !rule.validator(value)) {
        throw new Error(`${key} éªŒè¯å¤±è´¥`);
      }
    }
  }
  
  /**
   * è®¾ç½®æ•°æ®ï¼ˆå¸¦éªŒè¯ï¼‰
   */
  setData(key: string, value: any): void {
    this.validate(key, value);
    this.realService.setData(key, value);
  }
  
  /**
   * è·å–æ•°æ®
   */
  getData(key: string): any {
    return this.realService.getData(key);
  }
}
```

#### ä¸šåŠ¡ä¸­ä½¿ç”¨

```tsx
// services/formDataService.ts

import { ValidationProxy } from '../proxy/ValidationProxy';

// âœ… åˆ›å»ºå¸¦éªŒè¯çš„æ•°æ®æœåŠ¡
export const formDataService = new ValidationProxy();

// æ³¨å†ŒéªŒè¯è§„åˆ™
formDataService.registerRule('username', {
  required: true,
  type: 'string',
  min: 2,
  max: 20,
  pattern: /^[a-zA-Z0-9_]+$/,
});

formDataService.registerRule('email', {
  required: true,
  type: 'string',
  pattern: /^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/,
});

formDataService.registerRule('age', {
  required: true,
  type: 'number',
  validator: (value) => value >= 18 && value <= 120,
});

// ç»„ä»¶ä¸­ä½¿ç”¨
const UserForm: React.FC = () => {
  const handleSubmit = () => {
    try {
      // âœ… è‡ªåŠ¨éªŒè¯ï¼Œä¸éœ€è¦æ‰‹åŠ¨å†™éªŒè¯ä»£ç 
      formDataService.setData('username', 'john');
      formDataService.setData('email', 'john@example.com');
      formDataService.setData('age', 25);
      
      message.success('æäº¤æˆåŠŸ');
    } catch (error) {
      message.error(error.message); // è‡ªåŠ¨æ˜¾ç¤ºéªŒè¯é”™è¯¯
    }
  };
  
  return (
    <Button onClick={handleSubmit}>
      æäº¤
    </Button>
  );
};
```

---

### ğŸ”§ å‰ç«¯å®æˆ˜æ¡ˆä¾‹å…­ï¼šæ—¥å¿—è®°å½•ä»£ç†

#### åœºæ™¯æè¿°

ä½¿ç”¨ä»£ç†æ¨¡å¼å®ç°æ—¥å¿—è®°å½•ï¼Œè®°å½•å¯¹è±¡è®¿é—®æ—¥å¿—ã€‚

```tsx
// proxy/LoggingProxy.ts

/**
 * æ—¥å¿—çº§åˆ«
 */
type LogLevel = 'info' | 'warn' | 'error';

/**
 * æ—¥å¿—è®°å½•å™¨æ¥å£
 */
interface Logger {
  log(level: LogLevel, message: string, data?: any): void;
}

/**
 * æ§åˆ¶å°æ—¥å¿—è®°å½•å™¨
 */
class ConsoleLogger implements Logger {
  log(level: LogLevel, message: string, data?: any): void {
    const timestamp = new Date().toISOString();
    const logMessage = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
    
    switch (level) {
      case 'info':
        console.log(logMessage, data || '');
        break;
      case 'warn':
        console.warn(logMessage, data || '');
        break;
      case 'error':
        console.error(logMessage, data || '');
        break;
    }
  }
}

/**
 * æ—¥å¿—è®°å½•ä»£ç†
 * 
 * è™šæ‹Ÿä»£ç†ï¼šåœ¨è°ƒç”¨çœŸå®æ–¹æ³•å‰åè®°å½•æ—¥å¿—
 */
export function createLoggingProxy<T extends object>(
  target: T,
  logger: Logger = new ConsoleLogger()
): T {
  return new Proxy(target, {
    get(target, prop, receiver) {
      const original = Reflect.get(target, prop, receiver);
      
      // å¦‚æœæ˜¯å‡½æ•°ï¼ŒåŒ…è£…å®ƒ
      if (typeof original === 'function') {
        return function (...args: any[]) {
          logger.log('info', `è°ƒç”¨æ–¹æ³•: ${String(prop)}`, { args });
          
          try {
            const result = original.apply(target, args);
            
            // å¦‚æœæ˜¯ Promiseï¼Œè®°å½•ç»“æœ
            if (result instanceof Promise) {
              return result
                .then((value) => {
                  logger.log('info', `æ–¹æ³•æˆåŠŸ: ${String(prop)}`, { result: value });
                  return value;
                })
                .catch((error) => {
                  logger.log('error', `æ–¹æ³•å¤±è´¥: ${String(prop)}`, { error });
                  throw error;
                });
            }
            
            logger.log('info', `æ–¹æ³•å®Œæˆ: ${String(prop)}`, { result });
            return result;
          } catch (error) {
            logger.log('error', `æ–¹æ³•å¼‚å¸¸: ${String(prop)}`, { error });
            throw error;
          }
        };
      }
      
      return original;
    },
  });
}
```

#### ä¸šåŠ¡ä¸­ä½¿ç”¨

```tsx
// services/userService.ts

class UserService {
  async getUser(id: string) {
    const response = await fetch(`/api/users/${id}`);
    return response.json();
  }
  
  async createUser(data: any) {
    const response = await fetch('/api/users', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    return response.json();
  }
}

// âœ… ä½¿ç”¨æ—¥å¿—ä»£ç†ï¼Œè‡ªåŠ¨è®°å½•æ‰€æœ‰æ–¹æ³•è°ƒç”¨
export const userService = createLoggingProxy(new UserService());

// ä½¿ç”¨
userService.getUser('123');
// è‡ªåŠ¨è¾“å‡ºæ—¥å¿—ï¼š
// [2024-01-01T00:00:00.000Z] [INFO] è°ƒç”¨æ–¹æ³•: getUser { args: ['123'] }
// [2024-01-01T00:00:00.100Z] [INFO] æ–¹æ³•æˆåŠŸ: getUser { result: {...} }
```

---

### ğŸ“Š æ¨¡å¼æ€»ç»“

#### âœ… ä¼˜ç‚¹

| ä¼˜ç‚¹ | è¯´æ˜ |
|------|------|
| **æ§åˆ¶è®¿é—®** | å¯ä»¥æ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—® |
| **èŒè´£åˆ†ç¦»** | ä¸šåŠ¡é€»è¾‘å’Œæ¨ªåˆ‡å…³æ³¨ç‚¹åˆ†ç¦» |
| **æ˜“äºæ‰©å±•** | å¯ä»¥åŠ¨æ€æ·»åŠ åŠŸèƒ½ |
| **æ€§èƒ½ä¼˜åŒ–** | å¯ä»¥å®ç°ç¼“å­˜ã€æ‡’åŠ è½½ç­‰ä¼˜åŒ– |
| **å®‰å…¨æ€§** | å¯ä»¥å®ç°æƒé™æ§åˆ¶ã€æ•°æ®éªŒè¯ |

#### âŒ ç¼ºç‚¹

| ç¼ºç‚¹ | è¯´æ˜ |
|------|------|
| **å¢åŠ å¤æ‚åº¦** | å¤šäº†ä¸€å±‚ä»£ç†ï¼Œä»£ç å¤æ‚åº¦å¢åŠ  |
| **æ€§èƒ½å¼€é”€** | ä»£ç†è°ƒç”¨æœ‰è½»å¾®æ€§èƒ½å¼€é”€ |
| **è°ƒè¯•å›°éš¾** | ä»£ç†é“¾å¯èƒ½å¾ˆé•¿ï¼Œè°ƒè¯•æ—¶è°ƒç”¨æ ˆè¾ƒæ·± |

#### ğŸ¯ é€‚ç”¨åœºæ™¯

| åœºæ™¯ | ç¤ºä¾‹ |
|------|------|
| **å›¾ç‰‡æ‡’åŠ è½½** | è™šæ‹Ÿä»£ç†ï¼Œå»¶è¿ŸåŠ è½½å›¾ç‰‡ |
| **API è¯·æ±‚ç¼“å­˜** | ç¼“å­˜ä»£ç†ï¼Œç¼“å­˜è¯·æ±‚ç»“æœ |
| **æƒé™æ§åˆ¶** | ä¿æŠ¤ä»£ç†ï¼Œæ§åˆ¶è®¿é—®æƒé™ |
| **é˜²æŠ–èŠ‚æµ** | ä¿æŠ¤ä»£ç†ï¼Œæ§åˆ¶è°ƒç”¨é¢‘ç‡ |
| **æ•°æ®éªŒè¯** | ä¿æŠ¤ä»£ç†ï¼ŒéªŒè¯æ•°æ® |
| **æ—¥å¿—è®°å½•** | è™šæ‹Ÿä»£ç†ï¼Œè®°å½•è®¿é—®æ—¥å¿— |

#### ğŸš« ä¸é€‚ç”¨åœºæ™¯

- ç®€å•åœºæ™¯ï¼Œä¸éœ€è¦æ§åˆ¶è®¿é—®
- æ€§èƒ½è¦æ±‚æé«˜ï¼Œä»£ç†å¼€é”€ä¸å¯æ¥å—
- ä»£ç†é“¾è¿‡é•¿ï¼Œå½±å“å¯è¯»æ€§

---

### ğŸ”„ ä¸å…¶ä»–æ¨¡å¼çš„åŒºåˆ«

| æ¨¡å¼ | å…³æ³¨ç‚¹ | åŒºåˆ« |
|------|--------|------|
| **ä»£ç†æ¨¡å¼** | è®¿é—®æ§åˆ¶ | æ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—® |
| **è£…é¥°å™¨æ¨¡å¼** | åŠŸèƒ½å¢å¼º | åŠ¨æ€æ·»åŠ åŠŸèƒ½ï¼Œä¸æ”¹å˜æ¥å£ |
| **é€‚é…å™¨æ¨¡å¼** | æ¥å£è½¬æ¢ | è®©ä¸å…¼å®¹çš„æ¥å£å¯ä»¥ä¸€èµ·å·¥ä½œ |
| **å¤–è§‚æ¨¡å¼** | ç®€åŒ–æ¥å£ | ä¸ºå¤æ‚ç³»ç»Ÿæä¾›ç®€å•æ¥å£ |

---

### ğŸ¤” é€‰æ‹©å»ºè®®ï¼šä»€ä¹ˆæ—¶å€™ç”¨ä»£ç†æ¨¡å¼ï¼Ÿ

é—®è‡ªå·±è¿™å‡ ä¸ªé—®é¢˜ï¼š

```
1. ä½ æ˜¯å¦éœ€è¦æ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—®ï¼Ÿ
   â†’ æ˜¯çš„è¯ï¼Œè€ƒè™‘ä»£ç†æ¨¡å¼

2. ä½ æ˜¯å¦éœ€è¦åœ¨è®¿é—®å¯¹è±¡å‰åæ·»åŠ åŠŸèƒ½ï¼Ÿ
   â†’ æ˜¯çš„è¯ï¼Œè€ƒè™‘ä»£ç†æ¨¡å¼

3. ä½ æ˜¯å¦éœ€è¦å»¶è¿Ÿåˆ›å»º/åŠ è½½å¯¹è±¡ï¼Ÿ
   â†’ æ˜¯çš„è¯ï¼Œè€ƒè™‘è™šæ‹Ÿä»£ç†

4. ä½ æ˜¯å¦éœ€è¦ç¼“å­˜å¯¹è±¡è®¿é—®ç»“æœï¼Ÿ
   â†’ æ˜¯çš„è¯ï¼Œè€ƒè™‘ç¼“å­˜ä»£ç†

5. ä½ æ˜¯å¦éœ€è¦æ§åˆ¶å¯¹è±¡è®¿é—®æƒé™ï¼Ÿ
   â†’ æ˜¯çš„è¯ï¼Œè€ƒè™‘ä¿æŠ¤ä»£ç†
```

---

### ğŸ“ æ–‡ä»¶ç»“æ„å‚è€ƒ

```
src/
â”œâ”€â”€ proxy/
â”‚   â”œâ”€â”€ ImageProxy.tsx              # å›¾ç‰‡æ‡’åŠ è½½ä»£ç†
â”‚   â”œâ”€â”€ ApiCacheProxy.ts            # API ç¼“å­˜ä»£ç†
â”‚   â”œâ”€â”€ PermissionProxy.ts          # æƒé™æ§åˆ¶ä»£ç†
â”‚   â”œâ”€â”€ ThrottleProxy.ts            # é˜²æŠ–èŠ‚æµä»£ç†
â”‚   â”œâ”€â”€ ValidationProxy.ts          # æ•°æ®éªŒè¯ä»£ç†
â”‚   â””â”€â”€ LoggingProxy.ts             # æ—¥å¿—è®°å½•ä»£ç†
â”œâ”€â”€ services/
â”‚   â””â”€â”€ userService.ts              # ä½¿ç”¨ä»£ç†çš„æœåŠ¡
â””â”€â”€ components/
    â”œâ”€â”€ ImageGallery.tsx            # ä½¿ç”¨å›¾ç‰‡ä»£ç†
    â””â”€â”€ SearchInput.tsx             # ä½¿ç”¨èŠ‚æµä»£ç†
```

---

> **ä¸‹ä¸€ç« é¢„å‘Šï¼šã€Šè§‚å¯Ÿè€…æ¨¡å¼ã€‹â€”â€” åˆ« Call æˆ‘ï¼Œæœ‰äº‹æˆ‘ä¼šé€šçŸ¥ä½ **
> 
> æˆ‘ä»¬å°†è®²è§£å¦‚ä½•é€šè¿‡è§‚å¯Ÿè€…æ¨¡å¼å®ç°äº‹ä»¶æ€»çº¿ã€çŠ¶æ€è®¢é˜…ã€è·¨ç»„ä»¶é€šä¿¡ç­‰ã€‚

---

*å¦‚æœ‰ç–‘é—®æˆ–å»ºè®®ï¼Œæ¬¢è¿äº¤æµï¼*

