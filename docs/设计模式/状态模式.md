## ç¬¬äºŒç« ï¼šçŠ¶æ€æ¨¡å¼ï¼ˆState Patternï¼‰

### ä¸€å¥è¯å¤§ç™½è¯

**å°±åƒäº¤é€šä¿¡å·ç¯**ï¼šçº¢ç¯æ—¶è½¦è¾†åœæ­¢ï¼Œç»¿ç¯æ—¶è½¦è¾†é€šè¡Œï¼Œé»„ç¯æ—¶è½¦è¾†å‡é€Ÿã€‚ä¿¡å·ç¯çš„çŠ¶æ€å˜äº†ï¼Œè½¦è¾†çš„è¡Œä¸ºä¹Ÿè·Ÿç€å˜ã€‚è€Œä¸”çŠ¶æ€ä¹‹é—´æœ‰é¡ºåºï¼šçº¢ç¯ â†’ ç»¿ç¯ â†’ é»„ç¯ â†’ çº¢ç¯ï¼Œå¾ªç¯å¾€å¤ã€‚

### å‰ç«¯ç—›ç‚¹

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ åœ¨åšä¸€ä¸ªè®¢å•ç®¡ç†ç³»ç»Ÿï¼Œè®¢å•æœ‰å¤šç§çŠ¶æ€ï¼Œæ¯ç§çŠ¶æ€ä¸‹èƒ½æ‰§è¡Œçš„æ“ä½œä¸ä¸€æ ·ï¼š

```typescript
// âŒ æ²¡æœ‰ä½¿ç”¨çŠ¶æ€æ¨¡å¼çš„ä»£ç ï¼šåˆ°å¤„éƒ½æ˜¯çŠ¶æ€åˆ¤æ–­
function handleOrderAction(order, action) {
  if (order.status === 'pending') {
    if (action === 'pay') {
      // æ”¯ä»˜é€»è¾‘
      order.status = 'paid';
      message.success('æ”¯ä»˜æˆåŠŸ');
    } else if (action === 'cancel') {
      // å–æ¶ˆé€»è¾‘
      order.status = 'cancelled';
      message.success('è®¢å•å·²å–æ¶ˆ');
    } else {
      message.error('å¾…æ”¯ä»˜çŠ¶æ€ä¸æ”¯æŒè¯¥æ“ä½œ');
    }
  } else if (order.status === 'paid') {
    if (action === 'ship') {
      // å‘è´§é€»è¾‘
      order.status = 'shipped';
      message.success('å·²å‘è´§');
    } else if (action === 'refund') {
      // é€€æ¬¾é€»è¾‘
      order.status = 'refunded';
      message.success('é€€æ¬¾æˆåŠŸ');
    } else {
      message.error('å·²æ”¯ä»˜çŠ¶æ€ä¸æ”¯æŒè¯¥æ“ä½œ');
    }
  } else if (order.status === 'shipped') {
    if (action === 'confirm') {
      // ç¡®è®¤æ”¶è´§é€»è¾‘
      order.status = 'completed';
      message.success('è®¢å•å·²å®Œæˆ');
    } else if (action === 'reject') {
      // æ‹’æ”¶é€»è¾‘
      order.status = 'rejected';
      message.success('å·²æ‹’æ”¶');
    } else {
      message.error('å·²å‘è´§çŠ¶æ€ä¸æ”¯æŒè¯¥æ“ä½œ');
    }
  }
  // ... æ¯ä¸ªçŠ¶æ€éƒ½è¦åˆ¤æ–­ä¸€é
}
```

**è¿™æ®µä»£ç çš„é—®é¢˜ï¼š**
1. ğŸŒªï¸ **çŠ¶æ€å’Œè¡Œä¸ºè€¦åˆ**ï¼šçŠ¶æ€åˆ¤æ–­å’Œä¸šåŠ¡é€»è¾‘æ··åœ¨ä¸€èµ·ï¼Œä¹±æˆä¸€å›¢
2. ğŸ”€ **çŠ¶æ€è½¬æ¢ä¸æ¸…æ™°**ï¼šå“ªä¸ªçŠ¶æ€èƒ½è½¬åˆ°å“ªä¸ªçŠ¶æ€ï¼Ÿä»£ç é‡Œçœ‹ä¸å‡ºæ¥
3. ğŸ› **å®¹æ˜“å‡ºé”™**ï¼šæ–°å¢çŠ¶æ€æˆ–æ“ä½œæ—¶ï¼Œè¦æ”¹å¥½å¤šåœ°æ–¹ï¼Œä¸€ä¸å°å¿ƒå°±æ¼äº†
4. ğŸ“š **éš¾ä»¥ç»´æŠ¤**ï¼šéšç€çŠ¶æ€å’Œæ“ä½œå¢å¤šï¼Œä»£ç å‘ˆæŒ‡æ•°çº§è†¨èƒ€

### æ¨¡å¼æ ¸å¿ƒæ¦‚å¿µ

**çŠ¶æ€æ¨¡å¼çš„æœ¬è´¨**ï¼šå¯¹è±¡çš„è¡Œä¸ºå–å†³äºå®ƒçš„çŠ¶æ€ï¼ŒçŠ¶æ€å˜äº†ï¼Œè¡Œä¸ºä¹Ÿå˜ã€‚

- **çŠ¶æ€ï¼ˆStateï¼‰**ï¼šæ¯ä¸ªçŠ¶æ€æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç±»ï¼Œå°è£…äº†è¯¥çŠ¶æ€ä¸‹çš„æ‰€æœ‰è¡Œä¸º
- **ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰**ï¼šæŒæœ‰å½“å‰çŠ¶æ€ï¼ŒæŠŠæ“ä½œå§”æ‰˜ç»™å½“å‰çŠ¶æ€å¤„ç†
- **çŠ¶æ€è½¬æ¢**ï¼šçŠ¶æ€ä¹‹é—´å¯ä»¥ç›¸äº’è½¬æ¢ï¼Œå½¢æˆçŠ¶æ€æœº

**ç±»æ¯”**ï¼šä½ æ˜¯ä¸€ä¸ªè‡ªåŠ¨å”®è´§æœºï¼ˆContextï¼‰ã€‚æŠ•å¸å‰ã€æŠ•å¸åã€å‡ºè´§ä¸­ã€å”®ç½„ï¼Œæ¯ä¸ªçŠ¶æ€ä¸‹ï¼ŒæŒ‰é’®çš„è¡Œä¸ºå®Œå…¨ä¸åŒã€‚æŠ•å¸å‰æŒ‰"å‡ºè´§"æ²¡ååº”ï¼ŒæŠ•å¸åæ‰èƒ½å‡ºè´§ã€‚

**çŠ¶æ€æ¨¡å¼ vs ç­–ç•¥æ¨¡å¼çš„åŒºåˆ«ï¼š**

| å¯¹æ¯”ç»´åº¦ | ç­–ç•¥æ¨¡å¼ | çŠ¶æ€æ¨¡å¼ |
|---------|---------|---------|
| **ç›®çš„** | å°è£…ç®—æ³•ï¼Œè®©å®ƒä»¬å¯äº’æ¢ | å°è£…çŠ¶æ€ï¼Œè®©è¡Œä¸ºéšçŠ¶æ€å˜åŒ– |
| **æ˜¯å¦æœ‰è½¬æ¢** | ç­–ç•¥ä¹‹é—´**ç‹¬ç«‹**ï¼Œæ— è½¬æ¢å…³ç³» | çŠ¶æ€ä¹‹é—´**æœ‰è½¬æ¢**ï¼Œå½¢æˆçŠ¶æ€æœº |
| **è°æ§åˆ¶åˆ‡æ¢** | å®¢æˆ·ç«¯é€‰æ‹©ç”¨å“ªä¸ªç­–ç•¥ | çŠ¶æ€è‡ªå·±å†³å®šä½•æ—¶åˆ‡æ¢ |
| **å…¸å‹åœºæ™¯** | æ”¯ä»˜æ–¹å¼ã€æ ¡éªŒè§„åˆ™ | è®¢å•çŠ¶æ€ã€å®¡æ‰¹æµç¨‹ |

### å‰ç«¯å®æˆ˜æ¡ˆä¾‹

#### åœºæ™¯ï¼šè®¢å•ç®¡ç†ç³»ç»Ÿçš„çŠ¶æ€æµè½¬

æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªè®¢å•è¯¦æƒ…é¡µï¼Œæ ¹æ®è®¢å•çŠ¶æ€å±•ç¤ºä¸åŒçš„æ“ä½œæŒ‰é’®ï¼Œå¹¶å¤„ç†çŠ¶æ€æµè½¬ï¼š

```typescript
// âœ… ä½¿ç”¨çŠ¶æ€æ¨¡å¼é‡æ„

import React, { useState } from 'react';
import { Card, Button, Space, message, Timeline, Tag } from 'antd';
import {
  ClockCircleOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  TruckOutlined,
} from '@ant-design/icons';

// 1ï¸âƒ£ å®šä¹‰è®¢å•æ¥å£
interface Order {
  id: string;
  amount: number;
  statusHistory: string[]; // è®°å½•çŠ¶æ€å˜æ›´å†å²
}

// 2ï¸âƒ£ å®šä¹‰çŠ¶æ€æ¥å£
abstract class OrderState {
  protected order: Order;
  protected context: OrderContext;

  constructor(order: Order, context: OrderContext) {
    this.order = order;
    this.context = context;
  }

  // æ¯ä¸ªçŠ¶æ€éƒ½è¦å®ç°è¿™äº›æ–¹æ³•
  abstract getStatusName(): string;
  abstract getStatusColor(): string;
  abstract getActions(): Array<{ label: string; action: () => void; type?: any }>;
  abstract getIcon(): React.ReactNode;
}

// 3ï¸âƒ£ å…·ä½“çŠ¶æ€ç±»ï¼šå¾…æ”¯ä»˜
class PendingState extends OrderState {
  getStatusName() {
    return 'å¾…æ”¯ä»˜';
  }

  getStatusColor() {
    return 'warning';
  }

  getIcon() {
    return <ClockCircleOutlined />;
  }

  getActions() {
    return [
      {
        label: 'å»æ”¯ä»˜',
        type: 'primary',
        action: () => {
          message.success('æ”¯ä»˜æˆåŠŸï¼');
          this.order.statusHistory.push('å·²æ”¯ä»˜');
          // çŠ¶æ€è½¬æ¢ï¼šå¾…æ”¯ä»˜ â†’ å·²æ”¯ä»˜
          this.context.setState(new PaidState(this.order, this.context));
        },
      },
      {
        label: 'å–æ¶ˆè®¢å•',
        action: () => {
          message.info('è®¢å•å·²å–æ¶ˆ');
          this.order.statusHistory.push('å·²å–æ¶ˆ');
          // çŠ¶æ€è½¬æ¢ï¼šå¾…æ”¯ä»˜ â†’ å·²å–æ¶ˆ
          this.context.setState(new CancelledState(this.order, this.context));
        },
      },
    ];
  }
}

// 4ï¸âƒ£ å…·ä½“çŠ¶æ€ç±»ï¼šå·²æ”¯ä»˜
class PaidState extends OrderState {
  getStatusName() {
    return 'å·²æ”¯ä»˜';
  }

  getStatusColor() {
    return 'processing';
  }

  getIcon() {
    return <CheckCircleOutlined />;
  }

  getActions() {
    return [
      {
        label: 'å‘è´§',
        type: 'primary',
        action: () => {
          message.success('å·²å‘è´§ï¼');
          this.order.statusHistory.push('å·²å‘è´§');
          // çŠ¶æ€è½¬æ¢ï¼šå·²æ”¯ä»˜ â†’ å·²å‘è´§
          this.context.setState(new ShippedState(this.order, this.context));
        },
      },
      {
        label: 'ç”³è¯·é€€æ¬¾',
        action: () => {
          message.info('é€€æ¬¾ç”³è¯·å·²æäº¤');
          this.order.statusHistory.push('é€€æ¬¾ä¸­');
          // çŠ¶æ€è½¬æ¢ï¼šå·²æ”¯ä»˜ â†’ é€€æ¬¾ä¸­
          this.context.setState(new RefundingState(this.order, this.context));
        },
      },
    ];
  }
}

// 5ï¸âƒ£ å…·ä½“çŠ¶æ€ç±»ï¼šå·²å‘è´§
class ShippedState extends OrderState {
  getStatusName() {
    return 'å·²å‘è´§';
  }

  getStatusColor() {
    return 'processing';
  }

  getIcon() {
    return <TruckOutlined />;
  }

  getActions() {
    return [
      {
        label: 'ç¡®è®¤æ”¶è´§',
        type: 'primary',
        action: () => {
          message.success('æ„Ÿè°¢æ‚¨çš„ç¡®è®¤ï¼');
          this.order.statusHistory.push('å·²å®Œæˆ');
          // çŠ¶æ€è½¬æ¢ï¼šå·²å‘è´§ â†’ å·²å®Œæˆ
          this.context.setState(new CompletedState(this.order, this.context));
        },
      },
      {
        label: 'ç”³è¯·å”®å',
        action: () => {
          message.info('å”®åç”³è¯·å·²æäº¤');
          this.order.statusHistory.push('å”®åä¸­');
          this.context.setState(new RefundingState(this.order, this.context));
        },
      },
    ];
  }
}

// 6ï¸âƒ£ å…·ä½“çŠ¶æ€ç±»ï¼šå·²å®Œæˆ
class CompletedState extends OrderState {
  getStatusName() {
    return 'å·²å®Œæˆ';
  }

  getStatusColor() {
    return 'success';
  }

  getIcon() {
    return <CheckCircleOutlined />;
  }

  getActions() {
    return [
      {
        label: 'å†æ¥ä¸€å•',
        type: 'primary',
        action: () => {
          message.success('å·²ä¸ºæ‚¨åˆ›å»ºæ–°è®¢å•');
        },
      },
      {
        label: 'è¯„ä»·',
        action: () => {
          message.info('è·³è½¬åˆ°è¯„ä»·é¡µé¢');
        },
      },
    ];
  }
}

// 7ï¸âƒ£ å…·ä½“çŠ¶æ€ç±»ï¼šå·²å–æ¶ˆ
class CancelledState extends OrderState {
  getStatusName() {
    return 'å·²å–æ¶ˆ';
  }

  getStatusColor() {
    return 'default';
  }

  getIcon() {
    return <CloseCircleOutlined />;
  }

  getActions() {
    return [
      {
        label: 'åˆ é™¤è®¢å•',
        type: 'default',
        action: () => {
          message.info('è®¢å•å·²åˆ é™¤');
        },
      },
    ];
  }
}

// 8ï¸âƒ£ å…·ä½“çŠ¶æ€ç±»ï¼šé€€æ¬¾ä¸­
class RefundingState extends OrderState {
  getStatusName() {
    return 'é€€æ¬¾ä¸­';
  }

  getStatusColor() {
    return 'processing';
  }

  getIcon() {
    return <ClockCircleOutlined />;
  }

  getActions() {
    return [
      {
        label: 'æŸ¥çœ‹è¿›åº¦',
        type: 'primary',
        action: () => {
          message.info('é€€æ¬¾é¢„è®¡3-5ä¸ªå·¥ä½œæ—¥åˆ°è´¦');
        },
      },
    ];
  }
}

// 9ï¸âƒ£ ä¸Šä¸‹æ–‡ï¼šè®¢å•ç®¡ç†å™¨
class OrderContext {
  private state: OrderState;
  private listeners: Array<() => void> = [];

  constructor(initialState: OrderState) {
    this.state = initialState;
  }

  // åˆ‡æ¢çŠ¶æ€
  setState(state: OrderState) {
    this.state = state;
    // é€šçŸ¥æ‰€æœ‰ç›‘å¬è€…çŠ¶æ€å·²å˜æ›´
    this.listeners.forEach((listener) => listener());
  }

  // è·å–å½“å‰çŠ¶æ€
  getState() {
    return this.state;
  }

  // è®¢é˜…çŠ¶æ€å˜æ›´
  subscribe(listener: () => void) {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter((l) => l !== listener);
    };
  }
}

// ğŸ”Ÿ React ç»„ä»¶ï¼šè®¢å•è¯¦æƒ…é¡µ
const OrderDetail: React.FC = () => {
  // æ¨¡æ‹Ÿè®¢å•æ•°æ®
  const [order] = useState<Order>({
    id: 'ORD20240101001',
    amount: 299,
    statusHistory: ['å¾…æ”¯ä»˜'],
  });

  // åˆå§‹åŒ–è®¢å•ä¸Šä¸‹æ–‡ï¼ˆåˆå§‹çŠ¶æ€ï¼šå¾…æ”¯ä»˜ï¼‰
  const [orderContext] = useState(() => {
    const context = new OrderContext(new PendingState(order, {} as OrderContext));
    // è¿™é‡Œéœ€è¦æŠŠ context ä¼ ç»™ stateï¼Œæ‰€ä»¥å…ˆåˆ›å»º contextï¼Œå†é‡æ–°è®¾ç½® state
    const initialState = new PendingState(order, context);
    context.setState(initialState);
    return context;
  });

  // å¼ºåˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“
  const [, forceUpdate] = useState({});

  // è®¢é˜…çŠ¶æ€å˜æ›´
  React.useEffect(() => {
    const unsubscribe = orderContext.subscribe(() => {
      forceUpdate({}); // çŠ¶æ€å˜äº†ï¼Œè§¦å‘é‡æ–°æ¸²æŸ“
    });
    return unsubscribe;
  }, [orderContext]);

  const currentState = orderContext.getState();

  return (
    <Card
      title={`è®¢å•è¯¦æƒ… - ${order.id}`}
      extra={
        <Tag color={currentState.getStatusColor()} icon={currentState.getIcon()}>
          {currentState.getStatusName()}
        </Tag>
      }
      style={{ maxWidth: 600, margin: '50px auto' }}
    >
      {/* è®¢å•é‡‘é¢ */}
      <div style={{ marginBottom: 20, fontSize: 16 }}>
        <strong>è®¢å•é‡‘é¢ï¼š</strong>
        <span style={{ color: '#ff4d4f', fontSize: 24, marginLeft: 10 }}>
          Â¥{order.amount}
        </span>
      </div>

      {/* æ“ä½œæŒ‰é’®ï¼šæ ¹æ®å½“å‰çŠ¶æ€åŠ¨æ€ç”Ÿæˆ */}
      <Space style={{ marginBottom: 30 }}>
        {currentState.getActions().map((action, index) => (
          <Button
            key={index}
            type={action.type || 'default'}
            onClick={action.action}
          >
            {action.label}
          </Button>
        ))}
      </Space>

      {/* çŠ¶æ€æµè½¬å†å² */}
      <Card title="çŠ¶æ€å†å²" size="small" style={{ backgroundColor: '#fafafa' }}>
        <Timeline
          items={order.statusHistory.map((status, index) => ({
            children: status,
            color: index === order.statusHistory.length - 1 ? 'green' : 'gray',
          }))}
        />
      </Card>
    </Card>
  );
};

export default OrderDetail;
```

#### ğŸ¯ ä½¿ç”¨çŠ¶æ€æ¨¡å¼åçš„å¥½å¤„

1. **çŠ¶æ€å’Œè¡Œä¸ºæ¸…æ™°åˆ†ç¦»**ï¼šæ¯ä¸ªçŠ¶æ€ç±»ç‹¬ç«‹ï¼ŒèŒè´£å•ä¸€
   ```typescript
   // æ–°å¢"å¾…è¯„ä»·"çŠ¶æ€ï¼ŒåŸæœ‰ä»£ç é›¶æ”¹åŠ¨
   class PendingReviewState extends OrderState {
     getStatusName() { return 'å¾…è¯„ä»·'; }
     getStatusColor() { return 'processing'; }
     getIcon() { return <StarOutlined />; }
     getActions() {
       return [
         {
           label: 'ç«‹å³è¯„ä»·',
           type: 'primary',
           action: () => {
             // è¯„ä»·é€»è¾‘
           }
         }
       ];
     }
   }
   ```

2. **çŠ¶æ€è½¬æ¢ä¸€ç›®äº†ç„¶**ï¼šçœ‹ä»£ç å°±çŸ¥é“çŠ¶æ€æµè½¬è·¯å¾„
   ```
   å¾…æ”¯ä»˜ â†’ å·²æ”¯ä»˜ â†’ å·²å‘è´§ â†’ å·²å®Œæˆ
      â†“        â†“        â†“
   å·²å–æ¶ˆ   é€€æ¬¾ä¸­   å”®åä¸­
   ```

3. **ç¬¦åˆå¼€é—­åŸåˆ™**ï¼šæ–°å¢çŠ¶æ€ä¸å½±å“ç°æœ‰çŠ¶æ€

---

#### ğŸ’¡ å†ä¸¾ä¸€ä¸ªåœºæ™¯ï¼šå®¡æ‰¹æµç¨‹ç®¡ç†

```typescript
import React, { useState } from 'react';
import { Card, Steps, Button, Space, message, Input, Form } from 'antd';

const { TextArea } = Input;

// å®¡æ‰¹å•æ•°æ®
interface ApprovalForm {
  id: string;
  title: string;
  content: string;
  currentStep: number;
  history: Array<{ state: string; comment: string; time: string }>;
}

// å®¡æ‰¹çŠ¶æ€æ¥å£
abstract class ApprovalState {
  protected form: ApprovalForm;
  protected context: ApprovalContext;

  constructor(form: ApprovalForm, context: ApprovalContext) {
    this.form = form;
    this.context = context;
  }

  abstract getStateName(): string;
  abstract getStepStatus(): 'wait' | 'process' | 'finish' | 'error';
  abstract getActions(): Array<{ label: string; action: (comment?: string) => void; type?: any }>;
  abstract canEdit(): boolean; // æ˜¯å¦å…è®¸ç¼–è¾‘
}

// è‰ç¨¿çŠ¶æ€
class DraftState extends ApprovalState {
  getStateName() { return 'è‰ç¨¿'; }
  getStepStatus() { return 'process'; }
  canEdit() { return true; }

  getActions() {
    return [
      {
        label: 'æäº¤å®¡æ‰¹',
        type: 'primary',
        action: () => {
          message.success('å·²æäº¤å®¡æ‰¹');
          this.form.currentStep = 1;
          this.form.history.push({
            state: 'æäº¤å®¡æ‰¹',
            comment: 'æäº¤å®¡æ‰¹ç”³è¯·',
            time: new Date().toLocaleString(),
          });
          this.context.setState(new PendingApprovalState(this.form, this.context));
        },
      },
      {
        label: 'åˆ é™¤',
        action: () => {
          message.info('å·²åˆ é™¤');
        },
      },
    ];
  }
}

// å®¡æ‰¹ä¸­çŠ¶æ€
class PendingApprovalState extends ApprovalState {
  getStateName() { return 'å®¡æ‰¹ä¸­'; }
  getStepStatus() { return 'process'; }
  canEdit() { return false; }

  getActions() {
    return [
      {
        label: 'å®¡æ‰¹é€šè¿‡',
        type: 'primary',
        action: (comment?: string) => {
          message.success('å®¡æ‰¹é€šè¿‡ï¼');
          this.form.currentStep = 2;
          this.form.history.push({
            state: 'å®¡æ‰¹é€šè¿‡',
            comment: comment || 'æ— ',
            time: new Date().toLocaleString(),
          });
          this.context.setState(new ApprovedState(this.form, this.context));
        },
      },
      {
        label: 'é©³å›',
        type: 'default',
        action: (comment?: string) => {
          message.warning('å·²é©³å›');
          this.form.currentStep = 3;
          this.form.history.push({
            state: 'å·²é©³å›',
            comment: comment || 'ä¸ç¬¦åˆè¦æ±‚',
            time: new Date().toLocaleString(),
          });
          this.context.setState(new RejectedState(this.form, this.context));
        },
      },
    ];
  }
}

// å·²é€šè¿‡çŠ¶æ€
class ApprovedState extends ApprovalState {
  getStateName() { return 'å·²é€šè¿‡'; }
  getStepStatus() { return 'finish'; }
  canEdit() { return false; }

  getActions() {
    return [
      {
        label: 'å½’æ¡£',
        action: () => {
          message.info('å·²å½’æ¡£');
        },
      },
    ];
  }
}

// å·²é©³å›çŠ¶æ€
class RejectedState extends ApprovalState {
  getStateName() { return 'å·²é©³å›'; }
  getStepStatus() { return 'error'; }
  canEdit() { return true; }

  getActions() {
    return [
      {
        label: 'é‡æ–°æäº¤',
        type: 'primary',
        action: () => {
          message.success('å·²é‡æ–°æäº¤');
          this.form.currentStep = 1;
          this.form.history.push({
            state: 'é‡æ–°æäº¤',
            comment: 'ä¿®æ”¹åé‡æ–°æäº¤',
            time: new Date().toLocaleString(),
          });
          this.context.setState(new PendingApprovalState(this.form, this.context));
        },
      },
      {
        label: 'åˆ é™¤',
        action: () => {
          message.info('å·²åˆ é™¤');
        },
      },
    ];
  }
}

// å®¡æ‰¹ä¸Šä¸‹æ–‡
class ApprovalContext {
  private state: ApprovalState;
  private listeners: Array<() => void> = [];

  constructor(initialState: ApprovalState) {
    this.state = initialState;
  }

  setState(state: ApprovalState) {
    this.state = state;
    this.listeners.forEach((listener) => listener());
  }

  getState() {
    return this.state;
  }

  subscribe(listener: () => void) {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter((l) => l !== listener);
    };
  }
}

// React ç»„ä»¶
const ApprovalManagement: React.FC = () => {
  const [form] = Form.useForm();
  const [approvalForm] = useState<ApprovalForm>({
    id: 'APPR20240101001',
    title: 'é‡‡è´­ç”³è¯·',
    content: 'ç”³è¯·é‡‡è´­åŠå…¬ç”¨å“',
    currentStep: 0,
    history: [
      { state: 'åˆ›å»ºè‰ç¨¿', comment: 'åˆ›å»ºå®¡æ‰¹å•', time: new Date().toLocaleString() }
    ],
  });

  const [context] = useState(() => {
    const ctx = new ApprovalContext({} as ApprovalState);
    ctx.setState(new DraftState(approvalForm, ctx));
    return ctx;
  });

  const [, forceUpdate] = useState({});

  React.useEffect(() => {
    const unsubscribe = context.subscribe(() => forceUpdate({}));
    return unsubscribe;
  }, [context]);

  const currentState = context.getState();

  const handleActionWithComment = (actionFn: (comment?: string) => void) => {
    form.validateFields().then((values) => {
      actionFn(values.comment);
      form.resetFields();
    });
  };

  return (
    <Card title="å®¡æ‰¹ç®¡ç†" style={{ maxWidth: 800, margin: '50px auto' }}>
      {/* æµç¨‹æ­¥éª¤ */}
      <Steps
        current={approvalForm.currentStep}
        status={currentState.getStepStatus()}
        items={[
          { title: 'æäº¤ç”³è¯·' },
          { title: 'å®¡æ‰¹ä¸­' },
          { title: 'å·²é€šè¿‡' },
          { title: 'å·²é©³å›' },
        ]}
        style={{ marginBottom: 30 }}
      />

      {/* å®¡æ‰¹å†…å®¹ */}
      <Card type="inner" title="å®¡æ‰¹è¯¦æƒ…" style={{ marginBottom: 20 }}>
        <p><strong>æ ‡é¢˜ï¼š</strong>{approvalForm.title}</p>
        <p><strong>å†…å®¹ï¼š</strong>{approvalForm.content}</p>
        <p><strong>å½“å‰çŠ¶æ€ï¼š</strong>{currentState.getStateName()}</p>
      </Card>

      {/* å®¡æ‰¹æ„è§ï¼ˆä»…å®¡æ‰¹ä¸­çŠ¶æ€æ˜¾ç¤ºï¼‰ */}
      {currentState instanceof PendingApprovalState && (
        <Form form={form} style={{ marginBottom: 20 }}>
          <Form.Item name="comment" label="å®¡æ‰¹æ„è§">
            <TextArea rows={3} placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§" />
          </Form.Item>
        </Form>
      )}

      {/* æ“ä½œæŒ‰é’® */}
      <Space style={{ marginBottom: 20 }}>
        {currentState.getActions().map((action, index) => (
          <Button
            key={index}
            type={action.type || 'default'}
            onClick={() => {
              if (currentState instanceof PendingApprovalState) {
                handleActionWithComment(action.action);
              } else {
                action.action();
              }
            }}
          >
            {action.label}
          </Button>
        ))}
      </Space>

      {/* å®¡æ‰¹å†å² */}
      <Card type="inner" title="å®¡æ‰¹å†å²" size="small">
        {approvalForm.history.map((item, index) => (
          <div key={index} style={{ marginBottom: 10, paddingBottom: 10, borderBottom: '1px solid #f0f0f0' }}>
            <div><strong>{item.state}</strong> - {item.time}</div>
            <div style={{ color: '#666' }}>æ„è§ï¼š{item.comment}</div>
          </div>
        ))}
      </Card>
    </Card>
  );
};

export default ApprovalManagement;
```

### æ¨¡å¼æ€»ç»“

#### âœ… ä¼˜ç‚¹

1. **çŠ¶æ€é€»è¾‘é›†ä¸­ç®¡ç†**ï¼šæ¯ä¸ªçŠ¶æ€çš„è¡Œä¸ºéƒ½åœ¨è‡ªå·±çš„ç±»é‡Œï¼Œä¸ä¼šæ•£è½å„å¤„
2. **çŠ¶æ€è½¬æ¢æ¸…æ™°**ï¼šçŠ¶æ€ä¹‹é—´çš„è½¬æ¢å…³ç³»ä¸€ç›®äº†ç„¶ï¼Œå½¢æˆå®Œæ•´çš„çŠ¶æ€æœº
3. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢çŠ¶æ€åªéœ€æ–°å»ºä¸€ä¸ªç±»ï¼Œä¸å½±å“ç°æœ‰çŠ¶æ€
4. **æ¶ˆé™¤æ¡ä»¶åˆ¤æ–­**ï¼šä¸å†éœ€è¦å¤§é‡çš„ if-else åˆ¤æ–­å½“å‰æ˜¯ä»€ä¹ˆçŠ¶æ€
5. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªçŠ¶æ€ç±»åªè´Ÿè´£ä¸€ä¸ªçŠ¶æ€çš„è¡Œä¸º

#### âŒ ç¼ºç‚¹

1. **ç±»çš„æ•°é‡å¢åŠ **ï¼šæ¯ä¸ªçŠ¶æ€éƒ½æ˜¯ä¸€ä¸ªç±»ï¼ŒçŠ¶æ€å¤šäº†ç±»ä¹Ÿå¤š
2. **çŠ¶æ€è½¬æ¢é€»è¾‘åˆ†æ•£**ï¼šè½¬æ¢é€»è¾‘åœ¨å„ä¸ªçŠ¶æ€ç±»ä¸­ï¼Œéœ€è¦é€šè¯»æ‰èƒ½ç†è§£å®Œæ•´æµç¨‹
3. **å¢åŠ å¤æ‚åº¦**ï¼šå¯¹äºç®€å•çš„çŠ¶æ€ç®¡ç†ï¼Œå¯èƒ½è¿‡åº¦è®¾è®¡

#### ğŸ¯ é€‚ç”¨åœºæ™¯

çŠ¶æ€æ¨¡å¼ç‰¹åˆ«é€‚åˆä»¥ä¸‹å‰ç«¯åœºæ™¯ï¼š

| åœºæ™¯ | è¯´æ˜ | å…¸å‹çŠ¶æ€ |
|------|------|---------|
| **è®¢å•ç³»ç»Ÿ** | è®¢å•çŠ¶æ€æµè½¬ | å¾…æ”¯ä»˜ â†’ å·²æ”¯ä»˜ â†’ å·²å‘è´§ â†’ å·²å®Œæˆ |
| **å®¡æ‰¹æµç¨‹** | å®¡æ‰¹å•çŠ¶æ€ç®¡ç† | è‰ç¨¿ â†’ å®¡æ‰¹ä¸­ â†’ å·²é€šè¿‡/å·²é©³å› |
| **ä»»åŠ¡ç®¡ç†** | ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ | æœªå¼€å§‹ â†’ è¿›è¡Œä¸­ â†’ å·²å®Œæˆ â†’ å·²å…³é—­ |
| **éŸ³è§†é¢‘æ’­æ”¾å™¨** | æ’­æ”¾å™¨çŠ¶æ€ | åœæ­¢ â†’ æ’­æ”¾ â†’ æš‚åœ â†’ ç¼“å†² |
| **è¿æ¥ç®¡ç†** | WebSocket/ç½‘ç»œè¿æ¥ | è¿æ¥ä¸­ â†’ å·²è¿æ¥ â†’ æ–­å¼€è¿æ¥ â†’ é‡è¿ä¸­ |
| **æ–‡æ¡£ç¼–è¾‘** | æ–‡æ¡£ç¼–è¾‘çŠ¶æ€ | åªè¯» â†’ ç¼–è¾‘ä¸­ â†’ ä¿å­˜ä¸­ â†’ å·²ä¿å­˜ |
| **æ¸¸æˆè§’è‰²** | è§’è‰²çŠ¶æ€ | ç«™ç«‹ â†’ è¡Œèµ° â†’ å¥”è·‘ â†’ è·³è·ƒ â†’ æ”»å‡» |

#### ğŸ¤” ä»€ä¹ˆæ—¶å€™è¯¥ç”¨çŠ¶æ€æ¨¡å¼ï¼Ÿ

**ä¸‰ä¸ªåˆ¤æ–­æ ‡å‡†ï¼š**

1. **å¯¹è±¡è¡Œä¸ºéšçŠ¶æ€å˜åŒ–å—ï¼Ÿ**
   - ä¸åŒçŠ¶æ€ä¸‹ï¼ŒåŒä¸€ä¸ªæ“ä½œæœ‰ä¸åŒçš„è¡Œä¸º

2. **çŠ¶æ€ä¹‹é—´æœ‰è½¬æ¢å…³ç³»å—ï¼Ÿ**
   - çŠ¶æ€ A å¯ä»¥è½¬æ¢åˆ°çŠ¶æ€ Bï¼Œä½†ä¸èƒ½ç›´æ¥è½¬åˆ°çŠ¶æ€ C

3. **ä»£ç é‡Œæœ‰å¤§é‡é’ˆå¯¹çŠ¶æ€çš„æ¡ä»¶åˆ¤æ–­å—ï¼Ÿ**
   - åˆ°å¤„éƒ½æ˜¯ `if (status === 'xxx')` çš„åˆ¤æ–­

**å¿«é€Ÿå†³ç­–æ ‘ï¼š**

```
ä½ çš„å¯¹è±¡æœ‰æ˜ç¡®çš„"çŠ¶æ€"æ¦‚å¿µå—ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ ä¸åŒçŠ¶æ€ä¸‹è¡Œä¸ºä¸åŒå—ï¼Ÿ
    â”‚        â”œâ”€ æ˜¯ â†’ çŠ¶æ€ä¹‹é—´æœ‰è½¬æ¢é¡ºåºå—ï¼Ÿ
    â”‚        â”‚        â”œâ”€ æ˜¯ â†’ âœ… ç”¨çŠ¶æ€æ¨¡å¼ï¼
    â”‚        â”‚        â””â”€ å¦ â†’ ğŸ¤” è€ƒè™‘ç­–ç•¥æ¨¡å¼
    â”‚        â””â”€ å¦ â†’ âŒ ä¸éœ€è¦
    â””â”€ å¦ â†’ âŒ ä¸éœ€è¦
```

#### ğŸ’¡ çŠ¶æ€æ¨¡å¼ vs ç­–ç•¥æ¨¡å¼å¯¹æ¯”æ€»ç»“

| ç‰¹å¾ | çŠ¶æ€æ¨¡å¼ | ç­–ç•¥æ¨¡å¼ |
|------|---------|---------|
| **æ ¸å¿ƒæ€æƒ³** | å¯¹è±¡åœ¨ä¸åŒçŠ¶æ€ä¸‹è¡Œä¸ºä¸åŒ | åŒä¸€è¡Œä¸ºæœ‰å¤šç§ç®—æ³•å¯é€‰ |
| **çŠ¶æ€/ç­–ç•¥é—´å…³ç³»** | æœ‰è½¬æ¢å…³ç³»ï¼ˆçŠ¶æ€æœºï¼‰ | ç‹¬ç«‹å¹³ç­‰ï¼Œæ— è½¬æ¢ |
| **è°æ§åˆ¶åˆ‡æ¢** | çŠ¶æ€è‡ªå·±æ§åˆ¶ï¼ˆå†…éƒ¨ï¼‰ | å®¢æˆ·ç«¯é€‰æ‹©ï¼ˆå¤–éƒ¨ï¼‰ |
| **å…¸å‹åœºæ™¯** | è®¢å•æµç¨‹ã€å®¡æ‰¹æµç¨‹ | æ”¯ä»˜æ–¹å¼ã€è¡¨å•æ ¡éªŒ |
| **ä¾‹å­** | çº¢ç»¿ç¯ï¼šçº¢ç¯ â†’ ç»¿ç¯ â†’ é»„ç¯ | å‡ºè¡Œæ–¹å¼ï¼šå¼€è½¦ã€ååœ°é“ã€éª‘è½¦ |

---

### ğŸ’¬ å°ç»“

çŠ¶æ€æ¨¡å¼å°±åƒç»™å¯¹è±¡è£…ä¸Šäº†"å˜å½¢é‡‘åˆš"çš„èƒ½åŠ›ï¼Œæ ¹æ®å½“å‰çŠ¶æ€è‡ªåŠ¨åˆ‡æ¢å½¢æ€å’ŒæŠ€èƒ½ã€‚

åœ¨å®é™…é¡¹ç›®ä¸­ï¼ŒçŠ¶æ€æ¨¡å¼èƒ½è®©ä½ çš„ä»£ç ï¼š
- ä»"åˆ°å¤„åˆ¤æ–­ status"å˜æˆ"çŠ¶æ€è‡ªå·±ç®¡ç†è¡Œä¸º"
- ä»"çŠ¶æ€è½¬æ¢æ··ä¹±"å˜æˆ"æ¸…æ™°çš„çŠ¶æ€æœº"
- ä»"æ–°å¢çŠ¶æ€æ”¹ä¸€å †ä»£ç "å˜æˆ"æ–°å¢çŠ¶æ€ç±»å³å¯"

**è®°ä½ä¸€å¥è¯**ï¼šå¦‚æœä½ çš„å¯¹è±¡æœ‰"ç”Ÿå‘½å‘¨æœŸ"æˆ–"å·¥ä½œæµ"çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯çŠ¶æ€æ¨¡å¼çš„å¤©ä¸‹ï¼

---

> ğŸ’¡ **æ€è€ƒé¢˜**ï¼šåœ¨ä½ çš„é¡¹ç›®ä¸­ï¼Œæœ‰æ²¡æœ‰ç±»ä¼¼è®¢å•ã€å®¡æ‰¹ã€ä»»åŠ¡è¿™æ ·æœ‰æ˜ç¡®çŠ¶æ€æµè½¬çš„åŠŸèƒ½ï¼Ÿè¯•ç€ç”¨çŠ¶æ€æ¨¡å¼é‡æ„ï¼Œçœ‹çœ‹ä»£ç æ˜¯ä¸æ˜¯å˜æ¸…æ™°äº†ï¼Ÿ

